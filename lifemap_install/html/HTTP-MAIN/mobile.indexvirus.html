<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
 		<meta http-equiv="X-UA-Compatible" content="IE=edge">		
 		<meta http-equiv="Content-Security-Policy">
<!-- 		<meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">
 -->
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
		<link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
		<link rel="manifest" href="img/site.webmanifest">
		<link rel="mask-icon" href="img/safari-pinned-tab.svg" color="#5bbad5">
		<meta name="msapplication-TileColor" content="#000000">
		<meta name="theme-color" content="#ffffff">



		<title>Virusmap (by Lifemap)</title>

		<!-- Bootstrap -->
		<link href="css/bootstrap.min.css" rel="stylesheet">
		<!-- font awesome -->
		<link rel="stylesheet" href="js/font-awesome-4.6.1/css/font-awesome.min.css">
		<!-- leaflet -->
		<link rel="stylesheet" href="js/leaflet/leaflet.css" />
		<!-- jqueryui -->
		<link href="js/searchbar/jquery-ui.css" rel="stylesheet" />

		<!-- SWIPeR --> 
		<link rel="stylesheet" href="css/swiper.min.css">
 		<script src="js/swiper.min.js"></script>


		<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
		<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->
		<script>
// //		document.addEventListener("deviceready", onDeviceReady, false);
// 		function onLoad() {
// 			console.log(navigator.language)
// 			//UNCOMMENT WHAT FOLLOWS WHEN THE FR VERSION IS READY. AND TERMINATE THE TRANSLATION (TODO)
// 			// if (navigator.language==="fr-FR") {
// 			//  	SwitchToFR()
// 			// }
// 			document.addEventListener("deviceready", onDeviceReady, false);
// 		}
// 		function SwitchToFR() {
// 				$("#searchinput").attr('placeholder', 'Chercher une espèce, un clade, ...');
// 				$("#gototuto").html('Tutoriel');
// 				$("#thetol").html("L'arbre du vivant")
// 				$("#about").html("À propos")
// 				$("#contact").html("Contact")
// 				$("#share").html("Partager")
// 				$("#flybutton").html('"Voler" dans l\'arbre')
// 				$("#flytext").html("Si cette case est cochée, le déplacement dans l'arbre après une recherche se fait par une animation.")
// 				$("#langchosen").html('Langue : FR')
// 		}
// 		function SwitchToEN() {
// 				$("#searchinput").attr('placeholder', 'Search species, clades, ...');
// 				$("#gototuto").html('Tutorial');
// 				$("#thetol").html("The Tree of Life")
// 				$("#about").html("About")
// 				$("#contact").html("Contact")
// 				$("#share").html("Share")
// 				$("#flybutton").html('"Fly" to new locations')
// 				$("#flytext").html('When checked, zooming to new locations after a search in the search bar will be done by a smooth animation')
// 				$("#langchosen").html('Langage : EN')
// 		}


// 		//can we add here a small code that will try to connect to the server and return a message if it didn(t work? We'll try
// 		function testCon() {
// 			$.ajax({url: "http://lifemap.univ-lyon1.fr",
// 				type: "HEAD",
// 				timeout:3000,
// 				statusCode: {
// 					200: function (response) {
// 						$("#loading").hide();
// 					},
// 					400: function (response) {
// 						$("#loading").hide();
// 						errmess();
// 					},
// 					0: function (response) {
// 						$("#loading").hide();
// 						errmess();
// 					}              
// 				},
// 				dataType : 'jsonp',
// 				jsonp : 'json.wrf'
// 			});
// 		}
// 		function errmess() {
// 			//we add elements to "loading" to explain that there was a problem
// 			$('#lostconnect').modal("toggle");
// 		}
// 	    function onDeviceReady() {	    	
// 			// testCon();
// 	    	flyvalue = window.localStorage.getItem("fly")
// 			if ( flyvalue=== null) {
// 				window.localStorage.setItem("fly", "false")
// 			}
// 			if ( flyvalue=== "true") { //la case était coché en quittant l"appli la dernière fois
// 				$("#ChoiceExplo").find('i').toggleClass('fa-square-o fa-check-square-o')
// 			}
// 			//IL FAUT LA COCHER
// 			//GESTION DE LA LANGUE
// 	    }



		</script>
		<style>
			body,html {
				height:100%;
			}
			.vcenter {
				display: inline-block;
				vertical-align: middle;
				float: none;
			}
			#searchinput {
				width: 100%;
				padding-left:60px;
				padding-right:30px;
				font-size:18px;
			}
			#searchclear {
				position: absolute;
				right: 10px;
				top: 0;
				bottom: 0;
				height: 20px;
				margin: auto;
				font-size: 20px;
				cursor: pointer;
				color: #585858;
			}
			#theMenu {
				font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
				font-size: 12pt;				
				font-weight: 600;
			}
			.menuentry {
				padding-top:10px;
				padding-bottom:10px;
			}
			#sandwich {
				position: absolute;
				left: 12px;
				top: 0;
				bottom: 0;
				height: 30px;
				margin: auto;
				font-size: 30px;
				cursor: pointer;
				color: #585858;
			}
			.routestick {
				box-shadow:1px 1px 2px 0.2px #656565;				
				background:white;
				padding-top: 5px;
				padding-bottom: 5px;
			}
			.papernote {
				color:#9ca7be;
				box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
				padding:10px;
				margin-top:15px;
				margin-bottom:15px;				
			}
			p {
				margin-bottom:0px;
			}
			.display-table{
		    	display: table;
			    table-layout: fixed;
			}

			.display-cell{
				display: table-cell;
			    vertical-align: middle;
			    float: none;
			}
			.btn-circle {
				width: 50px;
				height: 50px;
				text-align: center;
				padding: 10px 0;
				font-size: 20px;
				line-height: 1.42;
				border-radius: 50%;
				position:absolute;
				background: #b4c3e0;
				color:white;
				border:0px;
				bottom:20px;
				right:15px;
				box-shadow: 0 0 10px black;
			}
			.btn-circle2 {
				width: 50px;
				height: 50px;
				padding:0px;
				background-color: transparent;
				text-align: center;
				position:absolute;
				border:0px;
				bottom:20px;
				left:15px;
				box-shadow: 0 0 10px black;
			}
			.bottomleft {
				background-color: transparent;
				position:absolute;
				border:0px;
				bottom:20px;
				left:15px;
				z-index: 0;
			}
			span.sciname {
				font-size:small;
				color: #505050;
				font-size:16px;
	    	}
	    	span.scinameItalic {
				font-style: italic;
				font-size:16px;
				color: #505050 ;	
	    	}
	    	span.commonname {
	    		color: #505050 ;
				font-size:16px;	
	    	}
	    	span.rank {
				text-transform: uppercase;
				font-weight: bolder;
				font-size:x-small;
				color: #989898 ;	
	    	}
		    .ui-autocomplete {
				background:white;
				border:0px;
				border-radius: 5px;
				margin-top:25px;
				max-height:72%;
				overflow-y: auto;
				overflow-x: hidden;
		 		box-shadow: 0 0 5px black;
				position:absolute;
			}
			.swiper-container {
		        width: 100%;
        		height: 100%;
        		z-index:2000;
        		background: #000;
        		opacity: 0.95;
        		position:absolute;
			 }
		    .swiper-slide {
    	    	text-align: center;
    	    	font-size: 18px;
    	    	z-index:50;
    	    	background: #000;
    	    	/* Center slide text vertically */
    	    	display: -webkit-box;
    	    	display: -ms-flexbox;
    	    	display: -webkit-flex;
    	    	display: flex;
    	   		-webkit-box-pack: center;
				-ms-flex-pack: center;
				-webkit-justify-content: center;
				justify-content: center;
				-webkit-box-align: center;
				-ms-flex-align: center;
				-webkit-align-items: center;
				align-items: center;
		    }
		    .swiper-pagination-bullet {
			 	background: #ffffff;
			    opacity: .4;
			}
			.swiper-pagination-bullet-active {
 			   opacity: 1;
			   background: #007aff;
			}
			a {
				color:white;
				text-decoration: underline;
				font-weight: bold;
			}
			.men {
				font-size: 14pt;
			    border-bottom: 1px solid #e5e5e5;
			}
			.btn-sq {
			  width: 100px !important;
			  height: 100px !important;
			  font-size: 10px;
			}

			/*******************************
* MODAL AS LEFT/RIGHT SIDEBAR
* Add "left" or "right" in modal parent div, after class="modal".
* Get free snippets on bootpen.com
*******************************/

	.modal.left .modal-dialog,
	.modal.right .modal-dialog {
		position: fixed;
		margin: auto;
		width: 320px;
		height: 100%;
		-webkit-transform: translate3d(0%, 0, 0);
		    -ms-transform: translate3d(0%, 0, 0);
		     -o-transform: translate3d(0%, 0, 0);
		        transform: translate3d(0%, 0, 0);
	}

	.modal.left .modal-content,
	.modal.right .modal-content {
		height: 100%;
		overflow-y: auto;
	   -webkit-border-radius: 0px !important;
	    -moz-border-radius: 0px !important;
	    border-radius: 0px !important; 
	}
	
	.modal.left .modal-body,
	.modal.right .modal-body {
		padding: 15px 15px 80px;
	}

/*Left*/
	.modal.left.fade .modal-dialog{
		left: -320px;
		-webkit-transition: opacity 0.3s linear, left 0.3s ease-out;
		   -moz-transition: opacity 0.3s linear, left 0.3s ease-out;
		     -o-transition: opacity 0.3s linear, left 0.3s ease-out;
		        transition: opacity 0.3s linear, left 0.3s ease-out;
	}
	
	.modal.left.fade.in .modal-dialog{
		left: 0;
	}
	.fa{
		font-size: 23px;
	}

/*STYLES FOR SHARE BUTTONS*/
ul.share-buttons{
  list-style: none;
  padding: 0;
}

ul.share-buttons li{
  display: inline;
}

ul.share-buttons .sr-only {
  position: absolute;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  padding: 0;
  border: 0;
  height: 1px;
  width: 1px;
  overflow: hidden;
}

ul.share-buttons img{
  width: 32px;
}


		</style>
		<!--PHONE SPECIFIC FUNCTIONS-->


	<!-- Get ADRESS OF THE SERVER TO UPDATE URL. The variable is called ServerAddress and read from server-address.js-->
	<script src="server-address.js" type="text/javascript"></script>



	</head>
	<body style="background:black;">



<!--SWIPER TUTORIAL-->
	<div id = "tuto" class="swiper-container" hidden>
        <div onclick="closetheswiper(this)" style="position:absolute; top: 10px; right:10px; z-index:10; color:white;"><i class="fa fa-times fa-2x" aria-hidden="true"></i></div>
        <div class="swiper-wrapper">
            <div class="swiper-slide">
            	<div class="swiper-zoom-container">
					<div class="papernote">
						<p><i class='fa fa-question-circle fa-fw fa-lg'></i><br><br><b>Virusmap</b> is an interactive tool to explore the taxonomy of viruses. The concept used in <b>Virusmap</b> is the same than in <a href="http://lifemap.univ-lyon1.fr"><b>Lifemap</b></a> for visualizing the entire Tree of Life: exploring is done by zooming and panning.</p>
					</div>
                </div>
            </div>
            <div class="swiper-slide">
            	<div class="swiper-zoom-container">
					<div class="papernote">
						<p><i class='fa fa-info fa-fw  fa-lg'></i><br><br>The current tree contains 199 917 species and is based on the taxonomy published by the <a href="https://www.ncbi.nlm.nih.gov">NCBI</a>. The taxonomy is updated regularly.</p>
					</div>
                </div>
            </div>
			<div class="swiper-slide">
            	<div class="swiper-zoom-container">
					<div class="papernote">
						<p><i class='fa fa-hand-pointer-o fa-fw fa-lg'></i><br><br>All the nodes in the tree can be clicked. It displays information (description and picture) concerning the taxa (retrieved from the <i class='fa fa-wikipedia-w'></i>ikipedia page, if any). "Routes" in the taxonomy can also be displayed by clicking on <i class='fa fa-level-up'></i> on the bottom right corner and entering a source and a destination. </p>
					</div>
                </div>
            </div>
            <div class="swiper-slide">
            	<div class="swiper-zoom-container">
					<div class="papernote">
						<p><i class='fa fa-user fa-fw  fa-lg'></i><br><br>Virusmap, like Lifemap, was written by Damien M. de Vienne, a CNRS researcher working in the Laboratory of Biometry and Evolutionary Biology (LBBE) in Lyon (France) with support from the informatics departement (Stephane Delmotte and Bruno Spataro). </p>
					</div>
                </div>
            </div>
            <div class="swiper-slide">
            	<div class="swiper-zoom-container">
            		<div class="papernote">
						<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>
						<br><br>
						<p>
						<span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Virus and Lifemap</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://lbbe.univ-lyon1.fr/-de-Vienne-Damien-.html" property="cc:attributionName" rel="cc:attributionURL">Damien de Vienne / CNRS</a> are licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.<br></p>
					<div style="text-align:center; padding-top:20px;">
					    <img src="https://upload.wikimedia.org/wikipedia/en/thumb/2/2c/CNRS.svg/200px-CNRS.svg.png" height="40px"style="padding-right: 7px;">
					    <img src="img/lbbe-logo-2020.png" height="40px" style="padding-left: 7px;">
					  </div>				

					</div>
                </div>
            </div>
            <div class="swiper-slide"></div>

        </div>
        <!-- Add Pagination -->
        <div class="swiper-pagination"></div>
    </div>



		<!--MAP-->
		<div id="map" style="height:100%; z-index:0;">
		</div>
		<!--SIMPLE SEARCH DIV-->
		<div id="mainsearch" class="container-fluid" style="position: absolute; right:0px; left:0px; top:20px; background:transparent; margin: 10px 10px 0px 10px; padding:0px; z-index:10;">
			<div class="btn-group" style="width:100%;">
				<span id="sandwich" class="glyphicon glyphicon-menu-hamburger"></span>
				<input id="searchinput" type="search" class="form-control" style=" height:50px;" placeholder="Search species, clades, ...">
				<span id="searchclear" class="glyphicon glyphicon-remove"></span>
			</div>
		</div>
		<!--ITINERARY SEARCH BUTTON-->
		<a id="route" class="btn btn-default btn-circle">
			<i class="fa fa-level-up"></i>
		</a>
		<!--LOGO HELP BUTTON-->
		<!--
		<a id="logohelp" class="btn btn-default btn-circle2">
			<img src="img/LMicon1.png" width="50px" height="50px">
		</a>
		-->	
		<div class="bottomleft">
			<img src="img/virusmaplogo.png" height="40px">
		</div>
			
		<!-- ITINERARIES SEARCH DIV (TOP) -->
		<div id="route-top" class="container-fluid" style=" padding-left:15px; padding-right:35px; background:#b4c3e0; box-shadow: 0 0 10px black; position: absolute; right:0px; left:0px; top:0; z-index: 100;" hidden>
			<div class="row" style="height: 30px;">&nbsp;</div>
			<div class="row">
				<div class="col-xs-2" style=" padding-left:0px; padding-right:0px;"><a id="back-to-map" class="btn" style="color:white;"><i class="fa fa-arrow-left"></i></a></div>
				<div class="col-xs-10" style="padding-left:0px;">
					<input id="searchinput2" type="search" class="form-control" placeholder="From species, clade...">
				</div>
			</div>
			<div class="row">&nbsp;</div>
			<div class="row">
				<div class="col-xs-2"></div>
				<div class="col-xs-10" style="padding-left:0px;">
					<input id="searchinput3" type="search" class="form-control" placeholder="To species, clade...">
				</div>
			</div>
			<div class="row">&nbsp;</div>
		</div>	

		<!--ITINERARY RESULTS DIV (BOTTOM)-->
		<div id="route-bottom" class="container-fluid" style="position: absolute; right:0px; left:0px; bottom:0; z-index:1000; background:white; box-shadow: 0 0 10px black;" hidden>
			<div class="row" style="padding:10px;">
				<div class="col-xs-8 vcenter">
					<div class="row"><i class="fa fa-map-marker fa-fw" style="color:#ffcc00; text-shadow: 1px 1px 1px #ccc;"></i><span id="routefrom"></span></div>	
					<div class="row"><i class="fa fa-ellipsis-v fa-fw" style="color:grey;"></i></div>
					<div id="mrcablock" hidden>
						<div class="row"><i class="fa fa-map-marker fa-fw" style="color:red; text-shadow: 1px 1px 1px #ccc;"></i><span style="font-size: xx-small; font-weight: bold; color:red;">MRCA </span><span id="routemrca" style="font-weight: bold; color:red;"></span></div>
						<div class="row"><i class="fa fa-ellipsis-v fa-fw" style="color:grey;"></i></div>
					</div>
					<div class="row"><i class="fa fa-map-marker fa-fw" style="color:blue; text-shadow: 1px 1px 1px #ccc;"></i><span id="routeto"></span></div>	
				</div><!--
				      --><div class="col-xs-2 vcenter"><a href="#" id="recenter" class="btn btn-lg" style="color:#b4c3e0;"><i class="fa fa-dot-circle-o"></i></a></div><!--
				      --><div class="col-xs-2 vcenter"><a href="#" id="getroutedetails" class="btn btn-lg" style="color:#b4c3e0;"><i class="fa fa-list"></i></a></div>
			</div>
		</div>
		<!--ITINERARY DETAILS DIV ///// TODO-->
		<div id="route-details" class="container-fluid" style="position: absolute; right:0px; left:0px; top:0px; min-height: 100%; z-index:2000; background:#fafafa; box-shadow: 0 0 10px black;" hidden>
			<div class="row" style="padding-top:10px; padding-right: 10px; text-align:right;">
					<i id="closedetails" class="fa fa-times" style="color:grey; font-size:30px;"></i>
			</div>
			<div id="details-content" class="row" style="padding:10px;">
			</div>
			<hr>
			<div class="row" style="padding-bottom: 20px; text-align: center;">
					<button type="button" class="btn btn-default" id="closedetails2">Close</button>
			</div>
		</div>

		<!--MODAL DIV THAT WILL CONTAIN THE DESCRIPTION OF THE SPECIES + PICTURES-->
		<div id="myModal" class="modal fade" role="dialog">
			<div class="modal-dialog">
				<!-- Modal content-->
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<div id="modaltitle" class="modal-title"></div>
					</div>
					<div class="modal-body">
							<div id="modalbody-text" style="font-size: x-small; padding: 5px"></div>
							<div id="modalbody-pict" style="box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);"></div>	
							<div id="modalbody-links" class="modal-body"></div>	
					</div>
					<div class="modal-footer">
						<div class="row"> 
							<div class="col-xs-6 text-center">
								<button type="button" id="viewfullancestry" class="btn btn-primary">View full ancestry</button>
							</div>
							<div class="col-xs-6 text-center">
								<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>


		<!--LOST CONNECTION MODAL-->
		<div id="lostconnect" class="modal fade" role="dialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header text-center">
						<h4>CONNECTION PROBLEM</h4>
						<p style="color:grey;"><i class="fa fa-wifi" aria-hidden="true"></i><i class="fa fa-signal" aria-hidden="true"></i></p>
					</div>
					<div class="modal-body text-center">
						<p>There seems to be a problem with your internet connection. Please check that your device is connected to the internet.</p>
						<p>If the problem persists after restarting the app and ensuring that the device is properly connected, please contact damien.de-vienne@univ-lyon1.fr.</p>

					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>
		<!--MODAL WITH THE MENU -->	
		<div class="modal fade left" id="theMenu" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header" style="padding-top: 30px;">
 						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true" style="font-size:32px;">&times;</span></button>
						<h4 class="modal-title" id="myModalLabel">
							<img src = "img/virusmaplogo.png" width="40%" >&nbsp;
							<img class="center" src = "img/bylifemap.png" width="30%" style="vertical-align: bottom;">
						</h4>
					</div>
					<div class="modal-body text-justify" style="padding-bottom:10px;">
						<div class='row menuentry'>
							<div class='col-xs-2'><i class='fa fa-question-circle-o fa-lg fa-fw'></i></div>
							<div id="gototuto" class='col-xs-10 men'>About</div>
						</div> 
						<div class='row menuentry'>
							<div class='col-xs-2'><i class='fa fa-arrow-circle-o-right fa-lg fa-fw'></i></div>
							<div class='col-xs-10 men'>Quick access</div>
						</div> 
						<div class='row'>
							<div class='col-xs-2'></div>
							<div class='col-xs-10'>
								<div class="row"  onclick="zoomTo2('2697049')">+ Covid-19</div>
								<div class="row"  onclick="zoomTo2('12637')">+ Dengue</div>
								<div class="row"  onclick="zoomTo2('186536')">+ Ebola</div>
								<div class="row"  onclick="zoomTo2('11320')">+ Flu (Influenza A)</div>
								<div class="row"  onclick="zoomTo2('64320')">+ Zika</div>
							</div>
						</div>

<!-- 						<div class='row menuentry'>
							<div class='col-xs-2'><i class='fa fa-share-alt fa-lg fa-fw'></i></div>
							<div id="share" class='col-xs-10 men'>Share</div>
						</div>
 -->						<div class="row">&nbsp;</div>
						<div class='row'>
							<div class='col-xs-2' id="ChoiceExplo"><i class='fa fa-square-o fa-lg fa-fw'></i></div>
							<div id="flybutton" class='col-xs-10'>"Fly" to new locations</div>
						</div>
						<div id="flytext" class='row' style='color:grey; font-size: 10px; padding: 10px;'>When checked, zooming to new locations after a search in the search bar will be done by "flying"</div>
					</div>
					<div class="modal-footer" style='text-align:center; border-top: 0px;'>
				        <button type="button" class="btn btn-default" data-dismiss="modal" style='font-size:16px;'>Close</button>
				    </div>
				</div>
			</div>
		</div>

<!--					
					<div class="papernote">
						<p><i class='fa fa-question-circle fa-fw fa-lg' style='color:grey;'></i>&nbsp;<b>Lifemap</b> is an interactive tool to explore the tree of life. The concept used in <b>Lifemap</b> is similar to the one used in cartography with tools like Google Maps© or Open Street Maps: exploring is done by zooming and panning.</p>
					</div>
					<div class="papernote">
						<p><i class='fa fa-info fa-fw  fa-lg' style='color:grey;'></i>&nbsp;The current tree contains 802639 species: 3733 Archaea, 277426 Bacteria and 521480 Eukaryotes. It is based on the taxonomy publised by the NCBI and updated regularly.</p>
					</div>
					<div class="papernote">
						<p><i class='fa fa-hand-pointer-o fa-fw fa-lg' style='color:grey;'></i>&nbsp;All the nodes in the tree are clickable. It displays information (description and picture) concerning the taxa (retrieved from the <i class='fa fa-wikipedia-w'></i>ikipedia page, if any). If you have description or pictures you would like to see in Lifemap, simply create or update the corresponding <i class='fa fa-wikipedia-w'></i>ikipedia page. </p>
					</div>
					<div class="papernote">
						<p><i class='fa fa-level-up fa-fw fa-lg' style='color:grey;'></i>&nbsp;Itineraries between taxa can be computed by clicking on the bottom right button of the main page and filling the two search fields. When filled, the route is drawn between the taxa, the Most Recent Common Ancestor (MRCA) of the two groups/species is returned. The user gets also access to a list of all the nodes that are encountered in the way from one group to the other. This list is clickable.</p>
					</div>
					<div class="papernote">
						<p><i class='fa fa-user fa-fw  fa-lg' style='color:grey;'></i>&nbsp;Lifemap was written by Damien M. de Vienne, a CNRS researcher working in the Laboratory of Biometry and Evolutionary Biology (LBBE) in Lyon (France) with support from the informatics departement (especially Stephane Delmotte and Bruno Spattaro). </p>
					</div>
					<p  style="font-size: x-small; text-align: center;"><i>For any question, remark, suggestion, or bug report, please contact Damien de Vienne: damien.de-vienne@univ-lyon1.fr</i></p>
					<div class="modal-footer">					
				        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
-->

		<div id="AboutModal" class="modal fade" role="dialog">
		  <div class="modal-dialog" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		      </div>
		      <div class="modal-body">
				<div class="row">
			  <div class="col-xs-4">
			    <img src="img/ddv.png" width="100%">
			    <p style="font-size:6pt;text-align:center;">© Barbara Portailler</p>
			  </div>
			  <div class="col-xs-8">
			    <div>
			    <b>Lifemap was created by Damien M. de Vienne</b>, a CNRS researcher working at the Biometry and Evolutionary Biology Laboratory (<a href="http://lbbe.univ-lyon1.fr">LBBE</a>) in Lyon (France). He developed Lifemap with the technical support of the Informatics Pole of the laboratory, in particular Stéphane Delmotte and Bruno Spataro. 
			    </div>
			    <div style="padding-top: 10px; text-align: center; font-size:8pt;">
					For suggestions ,comments, etc: <a href="mailto:damien.de-vienne@univ-lyon1.fr"><i class='fa fa-envelope fa-fw fa-lg'></i></a>
			    </div>
			  </div>
			</div>
		      </div>
		      <div class="modal-footer">
			<div style="text-align:center;">
			  <img src="https://upload.wikimedia.org/wikipedia/en/thumb/2/2c/CNRS.svg/200px-CNRS.svg.png" height="40px">
			  <img src="https://upload.wikimedia.org/wikipedia/fr/7/7d/Logo_lbbe.png" height="40px">
			</div>
		        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
		      </div>
		    </div>		
		  </div>
		</div>

		<!-- SCRIPTS -->
		<!--SCRIPTS RELATED WITH THE PHONE CONNECTION TO INTERNET-->



		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src="js/jquery-1.12.3.min.js"></script>
		<!-- Include all compiled plugins (below), or include individual files as needed -->
		<script src="js/bootstrap.min.js"></script>
		<!-- Include leaflet -->
		<script src="js/leaflet/leaflet.js"></script>
		<!--JQUERY UI -->
		<script src="js/searchbar/jquery-ui.js"></script>
		<!--JQUERY UI HTML AUTOCOMPLETE EXTENSION-->
		<script src="js/searchbar/jquery.ui.autocomplete.html.js"></script>
		<!--HERE IS WHAT CONCERNS THE MAP AND MAP FUNCTION (focus, etc...)-->

		<script>
			$('#ChoiceExplo').click(function(){
				$(this).find('i').toggleClass('fa-square-o fa-check-square-o')
				str = $(this).find('i').attr('class');
				if (str.match("fa-check-square-o")===null) {
					window.localStorage.setItem("fly", "false")
				}
				else 
				{
					window.localStorage.setItem("fly", "true")
				}
		});
		</script>
		<script>
			var map = L.map('map', {zoomControl: false, attributionControl: false});
			var tolUrl="http://"+ServerAddress+"/osm_tiles/{z}/{x}/{y}.png";
			var tol = new L.TileLayer(tolUrl, {minZoom: 2, maxZoom: 42, detectRetina:false});
			map.addLayer(tol);
			map.setView([-5,0], 4);

			map.on("moveend", function() {
				CreatePopUps();
			})


			map.on("click", function() {
				$("#searchinput").blur();
				$("#searchinput2").blur();
				$("#searchinput3").blur();
				//we also decide to toggle route information with a simple click. 
				if (whichpage===1) {
					$("#route-top").toggle();
					if (map.hasLayer(polyline))	$("#route-bottom").toggle();
						//and also the itinerary button;				
					$("#route").toggle();
					$("#logohelp").toggle();
				}
				else {
					$("#mainsearch").toggle();
					$("#route").toggle();
					$("#logohelp").toggle();
				}

			})
			
			var SPfocus = L.marker([0,0]);
			var pointA = new L.LatLng(0,0);
			var pointB = new L.LatLng(1,1);
			var pointList = [pointA, pointB];
			var polyline = L.polyline(pointList);
			var markersRoute = new L.FeatureGroup();
			var markers = new L.FeatureGroup();
		</script>
		<!--VISUAL ELEMENTS (LOGOS, IMAGES, etc...)-->
		<script>
			var circl = L.icon({
				iconUrl: 'img/circl.png',
				iconSize:     [10, 10], // size of the icon
				iconAnchor:   [5, 5], // point of the icon which will correspond to marker's location
			});
			var mark = L.icon({
				iconUrl: 'img/mark.png',
				iconSize:     [40, 40], // size of the icon
				iconAnchor:   [20, 20], // point of the icon which will correspond to marker's location
			});

			var pin1 = L.icon({
				iconUrl: 'img/pin1.png',
				iconSize:     [18, 25], // size of the icon
				iconAnchor:   [9, 30], // point of the icon which will correspond to marker's location
			});
			var pin2 = L.icon({
				iconUrl: 'img/pin2.png',
				iconSize:     [18, 25], // size of the icon
				iconAnchor:   [9, 30], // point of the icon which will correspond to marker's location
			});
			var pin3 = L.icon({
				iconUrl: 'img/pin3.png',
				iconSize:     [18, 25], // size of the icon
				iconAnchor:   [9, 30], // point of the icon which will correspond to marker's location
			});
		</script>
		<!--INTERACTION (DIV SHOW/HIDE, FOCUS ON SE ETC.)-->
		<script>
			var whichpage = 0;

			$("#route").click(function(){
				whichpage = 1;
				$("#route-top").show();
//				$("#route-suggestions").show();	
				$("#mainsearch").hide();		
				map.removeLayer(SPfocus);
				focusorgo();
			});
			$("#back-to-map").click(function(){
				$("#route-top").hide();
//				$("#route-suggestions").hide();	
				$("#route-bottom").hide();
				$("#mainsearch").show();
				whichpage = 0;

				map.removeLayer(markersRoute);
				map.removeLayer(polyline);
				//and we also clear the to and from variables
				taxidFrom = undefined; 
				taxidTo = undefined;
				//and we empty search fields
				$("#searchinput2").val('');
				$("#searchinput3").val('');
				$("#route").show();
				$("#logohelp").show();
			});
			$("#searchclear").click(function(){
				$("#searchinput").val('');
				$("#searchinput2").val('');
				$("#searchinput3").val('');
				taxidFrom = undefined;
				map.removeLayer(SPfocus);
			});
			$("#searchinput").focus(function() {
				$(this).autocomplete('search', $(this).val())
			})
			$("#searchinput2").focus(function() {
			    $("#route-bottom").hide();	
				$(this).autocomplete('search', $(this).val())
			})
			$("#searchinput3").focus(function() {
			    $("#route-bottom").hide();	
				$(this).autocomplete('search', $(this).val())
			})
			$("#searchinput2").keyup(function() {
				taxidFrom = undefined;
			});
			$("#searchinput3").keyup(function() {
				taxidTo = undefined;
			});
			$("#getroutedetails").click(function() {
				$("#route-details").show();
			});
			$("#closedetails").click(function() {
				$("#route-details").hide();
			});
			$("#closedetails2").click(function() {
				$("#route-details").hide();
			});
			$("#recenter").click(function() {
				mrcaroute();
			});
			$("#sandwich").click(function() {
				$("#theMenu").modal("toggle");
			})
			$("#about").click(function() {
//				$("#AboutModal").modal("toggle");
				$("#theMenu").modal("toggle");
				$("#aboutswiper").show();
				swiper2.slideTo(0);

			})
			$("#thetol").click(function() {
//				$("#AboutModal").modal("toggle");
				$("#theMenu").modal("toggle");
				$("#tolswiper").show();
				swiper3.slideTo(0);

			})
			$("#contact").click(function() {
//				$("#AboutModal").modal("toggle");
				$("#theMenu").modal("toggle");
				$("#contactswiper").show();
				swiper4.slideTo(0);

			})
			$("#share").click(function() {
//				$("#AboutModal").modal("toggle");
				$("#theMenu").modal("toggle");
				$("#shareswiper").show();
				swiper5.slideTo(0);

			})
			$("#gototuto").click(function() {
	      		$("#theMenu").modal("toggle");
				$("#tuto").show();
				swiper.slideTo(0);

			})
			function closetheswiper(x) {
	      		$("#theMenu").modal("toggle");
	      		$(x).parents('div').hide();

			}

			//HERE We create two variables that will be responsible for storing taxids of species from and two which roads may be computed
			var taxidFrom;
			var taxidTo;	
		</script>
		<!--MRCA-REALETED FUNCTIONS-->
		<script>
			function getMrca(a1, a2) {
	    	//we explore a1 and check if the value is present in a2.
	    	//if it is, we store both the corresponding indexes in a1 and a2 (and cut after?...)
	    		for (var i = 0; i < a1.length; i++) {
		    		if (a2.indexOf(a1[i]) != -1) {
			    		mrca = a1[i];
						break; 
				    }
			    }	
			    if (mrca===0) {mrca = 1;}
				return mrca;
			}
			function getRoute(a1, a2) {
	    		//we explore a1 and check if the value is present in a2.
	    		//if it is, we store both the corresponding indexes in a1 and a2 (and cut after?...)
	    		var res1 = [];
	    		var res2 = [];
	    		for (var i = 0; i < a1.length; i++) {
		    		res1.push(a1[i]);
		    		if (a2.indexOf(a1[i]) != -1) {
			    		var i2=a2.indexOf(a1[i]);
						break; 
					}
	    		}
			    for (var i = 0; i < i2; i++) {
				    res2.push(a2[i]);
			    }
				return res1.concat(res2.reverse());
		    }  


		    var zoomTo2 = function(taxid) {
		    	$("#theMenu").modal("hide");
		    	$("#searchclear").click();
				var url = "http://"+ServerAddress+"/solr/taxo/select?q=taxid:"+taxid+"&wt=json";
				if (taxid === 1) {
					if ($('#ChoiceExplo').find('i').attr('class').match("fa-check-square-o")===null) {
						map.setView(L.latLng([-4.226497,0]),7);
					}
					else {map.flyTo( L.latLng([-4.226497,0]),7);}
				}
				else if (typeof taxid != 'undefined') {
			  		$.ajax({
						url : url,
						success : function(data) {
						var docs = JSON.stringify(data.response.docs);
						var jsonData = JSON.parse(docs);
						console.log(jsonData[0])
						$("#searchinput").val(jsonData[0].sci_name);
						if ($('#ChoiceExplo').find('i').attr('class').match("fa-check-square-o")===null) {
							map.setView([parseFloat(jsonData[0].coordinates[0]),parseFloat(jsonData[0].coordinates[1])], jsonData[0].zoom);
						}
						else {	
							map.flyTo([parseFloat(jsonData[0].coordinates[0]),parseFloat(jsonData[0].coordinates[1])], parseInt(jsonData[0].zoom));		    
						}
						SPfocus = L.marker([parseFloat(jsonData[0].coordinates[0]),parseFloat(jsonData[0].coordinates[1])], {icon: pin1})		
						SPfocus.addTo(map);

					},
					dataType : 'jsonp',
					jsonp : 'json.wrf'
					});	    
				}
				else {
					alert('We could not Zoom to this location. \nPlease send and email to damien.de-vienne@univ-lyon1.fr explaining this issue and the taxid that was problematic.');
				}



		    }




		    var zoomTo = function(taxid) {
				$("#route-details").hide();
				var url = "http://"+ServerAddress+"/solr/taxo/select?q=taxid:"+taxid+"&wt=json";
				if (taxid === 1) {
					if ($('#ChoiceExplo').find('i').attr('class').match("fa-check-square-o")===null) {
						map.setView(L.latLng([-4.226497,0]),7);
					}
					else {map.flyTo( L.latLng([-4.226497,0]),7);}
				}
				else if (typeof taxid != 'undefined') {
			  		$.ajax({
						url : url,
						success : function(data) {
						var docs = JSON.stringify(data.response.docs);
						var jsonData = JSON.parse(docs);
						if ($('#ChoiceExplo').find('i').attr('class').match("fa-check-square-o")===null) {
							map.setView([parseFloat(jsonData[0].coordinates[0]),parseFloat(jsonData[0].coordinates[1])], jsonData[0].zoom);
						}
						else {	
							map.flyTo([parseFloat(jsonData[0].coordinates[0]),parseFloat(jsonData[0].coordinates[1])], parseInt(jsonData[0].zoom));		    
						}
					},
					dataType : 'jsonp',
					jsonp : 'json.wrf'
					});	    
				}
				else {
					alert('We could not Zoom to this location. \nPlease send and email to damien.de-vienne@univ-lyon1.fr explaining this issue and the taxid that was problematic.');
				}
			};
			//We create here the function that will build popups (modals).
			function CreatePopUps() {
			//we only remove markers that have their popup closed.
				map.removeLayer(markers);
				markers = new L.FeatureGroup();
				z = map.getZoom() + 4;
				bb = map.getBounds();
				var lon1 = bb._southWest.lng;
				var lon2 = bb._northEast.lng;
				var lat1 = bb._southWest.lat;
				var lat2 = bb._northEast.lat;
				var URL2 = "http://"+ServerAddress+"/solr/taxo/select?q=*:*&fq=zoom:[0 TO " + z + "]&fq=lat:[" + lat1 + " TO " + lat2 + "]&fq=lon:[" + lon1 + " TO " + lon2 + "]&wt=json&rows=1000";

				$.ajax({
					url : URL2,
					success : function(data) {
						var ok = data.response.docs;
						$.each(ok, function( index, value ) {
							var latlong = new L.LatLng(ok[index].lat[0], ok[index].lon[0]);
							var marker = L.marker(latlong,{icon: mark});
							var str = ok[index].all;
							str=str.split("|");
							var spname = str[0];					  
							var comname = str[1];
							var rank = str[2];
							var taxid = str[3];
							marker.on("click", function() {
								markofun(taxid, spname, comname, rank);
							})
							markers.addLayer(marker);
							}
						);
					},
				dataType : 'jsonp',
				jsonp : 'json.wrf'
				});
				//We need to create something for the root as well.
				var marker = L.marker([-4.226497,0], {icon: mark, zIndexOffset:-1000});
				//create and bind content to marker (TODO)
				//bind marker to markers group
				markers.addLayer(marker);
				markers.addTo(map);
			}; 
		</script>
		<!--WIKIPEDIA RELATED FUNCTION-->
		<script>
			function getWikiDesc (spname) {
				var res = '';
				return $.getJSON(wikiurl="https://en.wikipedia.org/w/api.php?format=json&action=query&prop=extracts|pageimages&titles="+spname+"&redirects&exsentences=3&piprop=original|thumbnail|name&pithumbsize=300&callback=?").then(function(data){
					var page = data.query.pages;
					key = Object.keys(page)[0]
					if (key!="-1") {
						res = page[key];
						return res;
					}
					else {
						return null;
					}
				});
			}

		</script>


		<!--MAIN SEARCH FUNCTIONS (SINGLE AND ITINERARY)-->
		<script>
			//This little code fixes the width of the suggestions
			jQuery.ui.autocomplete.prototype._resizeMenu = function () {
	 			var ul = this.menu.element;
	 	 		ul.outerWidth(this.element.outerWidth());
			}
			//SEARCH FUNCTIONS
			$(function() {
				var str;
				var URL_PREFIX = "http://"+ServerAddress+"/solr/taxo/suggesthandler?suggest.q=";
				var URL_PREFIX_FINAL = "http://"+ServerAddress+"/solr/taxo/select?q=taxid:";
				var URL_SUFFIX = "&wt=json";
				$("#searchinput").autocomplete({
					//ONLY FOR IOS: 
					open: function(event, ui) {
    				    $('.ui-autocomplete').off('menufocus hover mouseover mouseenter');
				    },
				    //END ONLY FOR IOS
					source : function(request, response) {
						var URL = URL_PREFIX + $("#searchinput").val() + URL_SUFFIX;
						$.ajax({
							url : URL,
							success : function(data) {
								var step1=data.suggest.mySuggester[$("#searchinput").val()];
								var docs = JSON.stringify(step1.suggestions);
								var jsonData = JSON.parse(docs);
								jsonData.sort(function(a,b) {
									a1 = a.term.split("|")[0].replace(/<b>/g,"").replace(/<\/b>/g,"");
									b1 = b.term.split("|")[0].replace(/<b>/g,"").replace(/<\/b>/g,"");
									return(a1.length-b1.length);
								})
									response($.map(jsonData, function(value, key) {
										str = value.term;
										str=str.split("|");
										var issp = str[2];
										issp = issp.replace(/<b>/g,"");
										issp = issp.replace(/<\/b>/g,"");
										issp = issp.replace(" ","");
										issp = issp.replace(/[\x00-\x2f\x3a-\x40]/g,"");
										var taxid = str[3];
										taxid = taxid.replace(/<b>/g,"");
										taxid = taxid.replace(/<\/b>/g,"");
										taxid = taxid.replace(" ","");
										taxid = taxid.replace(/[\x00-\x2f\x3a-\x40]/g,"");
										var spname = str[0];
										spname=spname.replace(/<b>/g,"");
										spname=spname.replace(/<\/b>/g,"");
										var commonname = str[1];
										commonname=commonname.replace(/<b>/g,"");
										commonname=commonname.replace(/<\/b>/g,"");
										var renderval = spname + commonname;

										if ((issp==="species")||(issp==="subspecies")) {
											labOK = "<div style='border-bottom:1px solid #989898; padding: 20px;'><span class=\"scinameItalic\">" + str[0] + "</span><span class=\"commonname\">" + str[1] + "</span><br><span class=\"rank\" >" + str[2] + "</span></div>";			
										}
										else {
											labOK = "<div style='border-bottom:1px solid #989898; padding: 20px;'><span class=\"sciname\">" + str[0] + "</span><span class=\"commonname\">" + str[1] + "</span><br><span class=\"rank\">" + str[2] + "</span></div>";
										}
										return {
											label : labOK,
											value : renderval,
											taxidfinal: taxid,
											spname:spname,
											commonname:commonname,
											rank:issp											
										}
									}));
							},
							dataType : 'jsonp',
							jsonp : 'json.wrf'
						});
					},
					minLength : '1',
					autoFocus: false,
					html: true,
					focus: function() {
				    		// prevent value inserted on focus
				    		return false;
					},
					select: function(e, ui) {
						var taxidok = ui.item.taxidfinal;
						var spnameok = ui.item.spname;	
						var commonnameok = ui.item.commonname;
						var rankok = ui.item.rank;
						//We copy the search to the search box for the ways.
						$("#searchinput2").val(ui.item.value);
						//We store the taxid to variable taxidFrom.
						taxidFrom = taxidok;
						$("#searchinput").blur();						
						var URL = URL_PREFIX_FINAL + taxidok + URL_SUFFIX;
						$.ajax({
							url : URL,
							success : function(data) {
								map.removeLayer(SPfocus);
								var docs = JSON.stringify(data.response.docs);
								var jsonData = JSON.parse(docs);
								//map.setView([parseFloat(jsonData[0].coordinates[0]),parseFloat(jsonData[0].coordinates[1])], jsonData[0].zoom-1);

								if ($('#ChoiceExplo').find('i').attr('class').match("fa-check-square-o")===null) {
									map.setView([parseFloat(jsonData[0].coordinates[0]),parseFloat(jsonData[0].coordinates[1])], jsonData[0].zoom-1);
								}
								else {
									map.flyTo([parseFloat(jsonData[0].coordinates[0]),parseFloat(jsonData[0].coordinates[1])], parseInt(jsonData[0].zoom-1));
								}	

								SPfocus = L.marker([parseFloat(jsonData[0].coordinates[0]),parseFloat(jsonData[0].coordinates[1])], {icon: pin1})								
								SPfocus.on("click", function() {
									markofun(taxidok, spnameok,commonnameok,rankok);
								})
								SPfocus.addTo(map);
							},
							dataType : 'jsonp',
							jsonp : 'json.wrf'
						});	    
					}
				})
			});
			$(function() {
				var str;
				var URL_PREFIX = "http://"+ServerAddress+"/solr/taxo/suggesthandler?suggest.q=";
				var URL_PREFIX_FINAL = "http://"+ServerAddress+"/solr/taxo/select?q=taxid:";
				var URL_SUFFIX = "&wt=json";
				$("#searchinput2").autocomplete({
					source : function(request, response) {
						var URL = URL_PREFIX + $("#searchinput2").val() + URL_SUFFIX;
						$.ajax({
							url : URL,
							position: { my: "left top", at: "left bottom", of: ".test" },
							success : function(data) {
								var step1=data.suggest.mySuggester[$("#searchinput2").val()];
								var docs = JSON.stringify(step1.suggestions);
								var jsonData = JSON.parse(docs);
								jsonData.sort(function(a,b) {
									a1 = a.term.split("|")[0].replace(/<b>/g,"").replace(/<\/b>/g,"");
									b1 = b.term.split("|")[0].replace(/<b>/g,"").replace(/<\/b>/g,"");
									return(a1.length-b1.length);
								})
								response($.map(jsonData, function(value, key) {
									str = value.term;
									str=str.split("|");
									var issp = str[2];
									issp = issp.replace(/<b>/g,"");
									issp = issp.replace(/<\/b>/g,"");
									issp = issp.replace(" ","");
									issp = issp.replace(/[\x00-\x2f\x3a-\x40]/g,"");
									var taxid = str[3];
									taxid = taxid.replace(/<b>/g,"");
									taxid = taxid.replace(/<\/b>/g,"");
									taxid = taxid.replace(" ","");
									taxid = taxid.replace(/[\x00-\x2f\x3a-\x40]/g,"");
									var spname = str[0];
									spname=spname.replace(/<b>/g,"");
									spname=spname.replace(/<\/b>/g,"");
									var commonname = str[1];
									commonname=commonname.replace(/<b>/g,"");
									commonname=commonname.replace(/<\/b>/g,"");
									var renderval = spname + commonname;

									if ((issp==="species")||(issp==="subspecies")) {
										labOK = "<div style='border-bottom:1px solid #989898; padding: 20px;'><span class=\"scinameItalic\">" + str[0] + "</span><span class=\"commonname\">" + str[1] + "</span><br><span class=\"rank\" >" + str[2] + "</span></div>";			
									}
									else {
										labOK = "<div style='border-bottom:1px solid #989898; padding: 20px;'><span class=\"sciname\">" + str[0] + "</span><span class=\"commonname\">" + str[1] + "</span><br><span class=\"rank\">" + str[2] + "</span></div>";
									}
									return {
										label : labOK,
										value : renderval,
										taxidfinal: taxid
									}
								}));
							},
							dataType : 'jsonp',
							jsonp : 'json.wrf'
						});
					},
					minLength : '1',
					autoFocus: false,
					html: true,
					focus: function() {
				    		// prevent value inserted on focus
				    		return false;
					},
					select: function(e, ui) {
						var taxidok = ui.item.taxidfinal;			    
						//We store the taxid to variable taxidFrom
						taxidFrom = taxidok;
						$("#searchinput2").blur();
						focusorgo();
					}, 
				})
			});
			$(function() {
				var str;
				var URL_PREFIX = "http://"+ServerAddress+"/solr/taxo/suggesthandler?suggest.q=";
				var URL_PREFIX_FINAL = "http://"+ServerAddress+"/solr/taxo/select?q=taxid:";
				var URL_SUFFIX = "&wt=json";
				$("#searchinput3").autocomplete({
					source : function(request, response) {
						var URL = URL_PREFIX + $("#searchinput3").val() + URL_SUFFIX;
						$.ajax({
							url : URL,
							position: { my: "left top", at: "left bottom", of: ".test" },
							success : function(data) {
								var step1=data.suggest.mySuggester[$("#searchinput3").val()];
								var docs = JSON.stringify(step1.suggestions);
								var jsonData = JSON.parse(docs);
								jsonData.sort(function(a,b) {
									a1 = a.term.split("|")[0].replace(/<b>/g,"").replace(/<\/b>/g,"");
									b1 = b.term.split("|")[0].replace(/<b>/g,"").replace(/<\/b>/g,"");
									return(a1.length-b1.length);
								})
								response($.map(jsonData, function(value, key) {
									str = value.term;
									str=str.split("|");
									var issp = str[2];
									issp = issp.replace(/<b>/g,"");
									issp = issp.replace(/<\/b>/g,"");
									issp = issp.replace(" ","");
									issp = issp.replace(/[\x00-\x2f\x3a-\x40]/g,"");
									var taxid = str[3];
									taxid = taxid.replace(/<b>/g,"");
									taxid = taxid.replace(/<\/b>/g,"");
									taxid = taxid.replace(" ","");
									taxid = taxid.replace(/[\x00-\x2f\x3a-\x40]/g,"");
									var spname = str[0];
									spname=spname.replace(/<b>/g,"");
									spname=spname.replace(/<\/b>/g,"");
									var commonname = str[1];
									commonname=commonname.replace(/<b>/g,"");
									commonname=commonname.replace(/<\/b>/g,"");
									var renderval = spname + commonname;

									if ((issp==="species")||(issp==="subspecies")) {
										labOK = "<div style='border-bottom:1px solid #989898; padding: 20px;'><span class=\"scinameItalic\">" + str[0] + "</span><span class=\"commonname\">" + str[1] + "</span><br><span class=\"rank\" >" + str[2] + "</span></div>";			
									}
									else {
										labOK = "<div style='border-bottom:1px solid #989898; padding: 20px;'><span class=\"sciname\">" + str[0] + "</span><span class=\"commonname\">" + str[1] + "</span><br><span class=\"rank\">" + str[2] + "</span></div>";
									}
									return {
										label : labOK,
										value : renderval,
										taxidfinal: taxid
									}
								}));
							},
							dataType : 'jsonp',
							jsonp : 'json.wrf'
						});
					},
					minLength : '1',
					autoFocus: false,
					html: true,
					focus: function() {
				    		// prevent value inserted on focus
				    		return false;
					},
					select: function(e, ui) {
						var taxidok = ui.item.taxidfinal;			    
						taxidTo = taxidok;
						$("#searchinput3").blur();
						focusorgo();
					}
				})
			});
		
			//Now we create a function that will handle the fact 
			//that the focus is always on the search box that is empty, and that when both are full, 
			//we start computing the route, etc...
			function focusorgo() {
				if ((taxidTo===undefined)&&(taxidFrom!=undefined)) {
					$("#searchinput3").focus();
				}
				else if ((taxidFrom===undefined)&&(taxidTo!=undefined)) {
					$("#searchinput2").focus();
				}
				else if ((taxidFrom===undefined)&&(taxidTo===undefined)) {
					$("#searchinput2").focus();
				}
				else { //Both are defined. We can go for it: search path etc.
					mrcaroute();
				}
			}
			function mrcaroute() {
				map.removeLayer(SPfocus);
				//get infos
				taxidFrom = taxidFrom.replace(/\s+/g, '');
				taxidTo = taxidTo.replace(/\s+/g, '');
				var url = "http://"+ServerAddress+"/solr/addi/select?q=*:*&fq=taxid:("+taxidFrom+" "+taxidTo+")&wt=json";
				$.ajax({
				    url : url,
				    success : function(data) {
					    var res = data.response.docs;
						var asc1 = res[0].ascend;
						asc1 = [parseInt(res[0].taxid)].concat(asc1);
						if ((taxidFrom==='1')||(taxidTo==='1')) {
							var route = asc1;
							var asc2 = [0];
						}
						else { 
							var asc2 = res[1].ascend;
							asc2 = [parseInt(res[1].taxid)].concat(asc2);
						    var route = getRoute(asc1,asc2);
						}
						if (taxidFrom!=res[0].taxid[0]) {
								route = route.reverse();
						}
						var mrca = getMrca(asc1,asc2);
						routeq = route.toString().replace(/,/g,' ');
						url2 = "http://"+ServerAddress+"/solr/taxo/select?q=*:*&fq=taxid:(" + routeq + ")&wt=json&rows=10000";

						$.ajax({
						    url : url2,
						    success: function(data2) {
							map.removeLayer(markersRoute);
							map.removeLayer(polyline);
							$("#details-content").empty();
							markersRoute = new L.FeatureGroup();
							//we get taxid order of this new list (different from the input order asked to solr
							dataok = data2.response.docs;
							//we try to put dataok in the original order
							var neworder = [];
							for (var j=0;j < dataok.length; j++) {
							    neworder[j] = dataok[j].taxid[0];
							}
							//we will store lat and longs here 
							latlngs = [];
							names = [];
							taxids = [];
							ranks = [];
							commons = [];
							for (j=0;j < route.length; j++) {
							    if (route[j]===0) { //we pass by the root
									latlngs[j] = L.latLng([-4.226497,0]);
									names[j] = "Root";
									taxids[j] = 1;
									ranks[j] = "Root";
									commons[j] = " ";
							    }
							    else {
									var where = neworder.indexOf(route[j]);
									latlngs[j] = L.latLng([dataok[where].lat[0],dataok[where].lon[0]]);
									names[j] = dataok[where].sci_name;
									taxids[j] = (dataok[where].taxid)[0];
									ranks[j] = (dataok[where].rank)[0];
									commons[j] = dataok[where].common_name;
									if (commons[j]===undefined) {commons[j] = " ";}
									else {commons[j] = " "+commons[j]+" ";}
							    }
							    var mark = L.marker(latlngs[j], {icon: circl, clickable:false}).setOpacity(0.6).addTo(map);
							    markersRoute.addLayer(mark);
							}
							var mrcaindex = taxids.indexOf(mrca);
							var sp1 = L.marker(latlngs[0], {icon: pin1});
							sp1.on("click", function() {
								markofun(taxids[0], names[0],commons[0], ranks[0]);
							})	
							markersRoute.addLayer(sp1);
							var sp2 = L.marker(latlngs[latlngs.length-1], {icon: pin3});
							sp2.on("click", function() {
								markofun(taxids[latlngs.length-1], names[latlngs.length-1],commons[latlngs.length-1], ranks[latlngs.length-1]);
							})	
							markersRoute.addLayer(sp2);
							if ((mrcaindex!=0)&&(mrcaindex!=(names.length-1))) { //case where there is no mrca (one of the clade is the mrca)
							    var spmrca = L.marker(latlngs[mrcaindex], {icon: pin2});
							    spmrca.on("click", function() {
									markofun(taxids[mrcaindex], names[mrcaindex],commons[mrcaindex], ranks[mrcaindex]);
								})
							    markersRoute.addLayer(spmrca);							    
   							    $("#routemrca").empty();
							    $("#routemrca").append(names[mrcaindex]);
   							    $("#mrcablock").show();	
								for (i=0;i<names.length;i++) {
									ht = "<div class='col-xs-12 vcenter' onclick='javascript:zoomTo("+taxids[i]+");'>";
									if (i!=0) {ht+= "<div class='row'><i class='fa fa-ellipsis-v fa-fw fa-lg' style='color:grey;'></i></div>";}
									if (i===0) { //from 
										ht+="<div class='row routestick'><i class='fa fa-map-marker fa-fw fa-lg' style='color:#ffcc00; text-shadow: 1px 1px 1px #ccc;'></i><span class='sciname'>"+names[i]+"</span>&nbsp<span class='rank'>"+ranks[i]+"</span></div>";
										ht+="</div>" //close xs-10 column
									}
									else if (i===mrcaindex) { //to
										ht+="<div class='row  routestick'><i class='fa fa-map-marker fa-fw fa-lg' style='color:red; text-shadow: 1px 1px 1px #ccc;'></i><span class='sciname'>"+names[i]+"</span>&nbsp<span class='rank'>"+ranks[i]+"</span></div>";
									}
									else if (i===(names.length-1)) { //to
										ht+="<div class='row routestick'><i class='fa fa-map-marker fa-fw fa-lg' style='color:blue; text-shadow: 1px 1px 1px #ccc;'></i><span class='sciname'>"+names[i]+"</span>&nbsp<span class='rank'>"+ranks[i]+"</span></div>";
									}
									else { //intermediate nodes
										ht+="<div class='row routestick'><i class='fa fa-caret-right fa-fw fa-lg' style='color:grey;'></i><span class='sciname'>"+names[i]+"</span>&nbsp<span class='rank'>"+ranks[i]+"</span></div>";	
									}
									$("#details-content").append(ht);
								}
							}
							else {
								$("#mrcablock").hide();	
								for (i=0;i<names.length;i++) {
									ht = "<div class='col-xs-12 vcenter' onclick='javascript:zoomTo("+taxids[i]+");'>";
									if (i!=0) {ht+= "<div class='row'><i class='fa fa-ellipsis-v fa-fw' style='color:grey;'></i></div>";}
									if (i===0) { //from 
										ht+="<div class='row routestick'><i class='fa fa-map-marker fa-fw fa-lg' style='color:#ffcc00; text-shadow: 1px 1px 1px #ccc;'></i><span class='sciname'>"+names[i]+"</span>&nbsp<span class='rank'>"+ranks[i]+"</span></div>";
										ht+="</div>" //close xs-10 column
									}
									else if (i===(names.length-1)) { //to
										ht+="<div class='row routestick'><i class='fa fa-map-marker fa-fw fa-lg' style='color:blue; text-shadow: 1px 1px 1px #ccc;'></i><span class='sciname'>"+names[i]+"</span>&nbsp<span class='rank'>"+ranks[i]+"</span></div>";
									}
									else { //intermediate nodes
										ht+="<div class='row routestick'><i class='fa fa-caret-right fa-fw fa-lg' style='color:grey;'></i><span class='sciname'>"+names[i]+"</span>&nbsp<span class='rank'>"+ranks[i]+"</span></div>";	
									}
									$("#details-content").append(ht);
								}

							}
							polyline = L.polyline(latlngs, {color: 'red', clickable:false, weight:6, opacity:0.6});
							polyline.addTo(map);
							if (focus) map.fitBounds(polyline.getBounds(), {paddingTopLeft:[20,140], paddingBottomRight:[0,120]});
							markersRoute.addTo(map);
							$("#routefrom").empty();
							$("#routeto").empty();
							$("#routefrom").append(names[0]);
							$("#routeto").append(names[names.length-1]);
							$("#route-bottom").show();
						    },
						    dataType : 'jsonp',
						    jsonp : 'json.wrf'
							});
					},
		    		dataType : 'jsonp',
		    		jsonp : 'json.wrf'
		    	})};
			
		</script>
		<script>
		function markofun(taxid, spname,comname, rank) {
			taxi = taxid;
			spna = spname;
			comna = comname;
			$('#modaltitle').empty();
			$('#modalbody-text').empty();	
			$('#modalbody-pict').empty();
			$('#modalbody-links').empty();	
		    if ((rank==="species")||(rank===" species ")) {
				$('#modaltitle').append("<span class='scinameItalic'>"+spname+"</span>");	
		    }
		    else {
				$('#modaltitle').append("<span class='sciname'>"+spname+"</span>");	
			}
			$('#modaltitle').append("<span class='commonname'>"+comname+"</span>");
			$('#modaltitle').append("<span class='rank'>"+rank+"</span>");	
			text = "<div style='font-style:center; color:grey;'>No article concerning this group on <i class='fa fa-wikipedia-w'></i>ikipedia.</div>";
			pict = "";
			if (spname!="Root") {
				getWikiDesc(spname).then(function(resu){
					if (resu!=null) {
						text = '<div>' + resu.extract + '</div>';
						text += "<div style='padding-bottom:10px;text-align:right; font-size:xx-small;'><a href='https://en.wikipedia.org/wiki/" + spname + "' target='_blank' style='color:grey;'>more on <i class='fa fa-wikipedia-w'></i>ikipedia</a><br></div>";
						text += "<div style='padding-bottom:10px;text-align:right; font-size:xx-small;'><a href='https://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi?mode=info&id=" + taxi + "' target='_blank' style='color:grey;'>more on NCBI</a><br></div>";
						$('#modalbody-text').append(text);	
						if (resu.thumbnail!==undefined) {
							//we add the image to the popup
							pict = '<div><a href="https://en.wikipedia.org/wiki/' + spname + '" target="_blank"><img src ='+resu.thumbnail.source+' width="100%"></a></div>'
							$('#modalbody-pict').append(pict);
						}
						else {
							pict = "<div style='padding:10px; font-size:xx-small; text-align:center; color:grey;'> No picture associated to this articlke on Wikipedia. Click <a href='https://en.wikipedia.org/wiki/" + spname + "' target='_blank' style='color:grey;'>here</a> if you want to upload one now.</div>";
							$('#modalbody-pict').append(pict);
						}
					}
					else {
						$('#modalbody-text').append(text);
						$('#modalbody-pict').append(pict);
					}
				})
			}
			$('#myModal').modal('show');
			$('#viewfullancestry').on("click", function() {
				taxidFrom = taxi;
				taxidTo = "10239";
				$("#myModal").modal("hide");
				$("#mainsearch").hide();					
				$('#searchinput2').val(spna + comna);
				$('#searchinput3').val('Root');
				$("#route-top").show();
				mrcaroute();
			})
		};
		</script>

<!--SWIPER-->
<script>        
	var swiper = new Swiper('#tuto', {
        pagination: '.swiper-pagination',
        paginationClickable: true,
        observer: true,
        onReachEnd: function(swiper) {
      	//callback function code here
      		$("#tuto").hide();
      		$("#theMenu").modal("toggle");
	    }
    });  
    var swiper2 = new Swiper('#aboutswiper', {
        paginationClickable: true,
        observer: true,
        onReachEnd: function(swiper) {
      	//callback function code here
      		$("#aboutswiper").hide();
      		$("#theMenu").modal("toggle");
	    }
    });  
    var swiper3 = new Swiper('#tolswiper', {
        paginationClickable: true,
        observer: true,
        onReachEnd: function(swiper) {
      	//callback function code here
      		$("#tolswiper").hide();
      		$("#theMenu").modal("toggle");
	    }
    });  
    var swiper4 = new Swiper('#contactswiper', {
        paginationClickable: true,
        observer: true,
        onReachEnd: function(swiper) {
      	//callback function code here
      		$("#contactswiper").hide();
      		$("#theMenu").modal("toggle");
	    }
    });  
    var swiper5 = new Swiper('#shareswiper', {
        paginationClickable: true,
        observer: true,
        onReachEnd: function(swiper) {
      	//callback function code here
      		$("#shareswiper").hide();
      		$("#theMenu").modal("toggle");
	    }
    });  


    </script>
	</body>
</html>
